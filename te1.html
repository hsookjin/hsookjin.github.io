<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™”íˆ¬ í‚¤ì˜¤ìŠ¤í¬ AI</title>
    <style>
        body {
            font-family: 'Suit', sans-serif;
            background-color: #1a1a1a;
            color: white;
            text-align: center;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* ìƒë‹¨ ì ìˆ˜íŒ */
        .score-board {
            background: #2d3436;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .total-score {
            font-size: 2.5rem;
            font-weight: 900;
            color: #00cec9;
            margin: 0;
        }
        .last-card {
            font-size: 1rem;
            color: #aaa;
            height: 20px;
        }

        /* ë©”ì¸ ì¹´ë©”ë¼ ì˜ì—­ */
        .camera-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* ì‹¤ì œ ë¹„ë””ì˜¤ëŠ” í™”ë©´ì— ê½‰ ì°¨ê²Œ */
        #webcam-container {
            width: 100%;
            height: 100%;
            position: absolute;
        }
        canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ê°€ì´ë“œë¼ì¸ (ì¡°ì¤€ì ) */
        .guide-box {
            position: absolute;
            width: 250px;
            height: 350px;
            border: 4px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); /* ë°•ìŠ¤ ì™¸ë¶€ëŠ” ì–´ë‘¡ê²Œ */
            z-index: 20;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* ì¡°ì¤€ì  ì‹­ìê°€ */
        .guide-box::after {
            content: "+";
            font-size: 50px;
            color: rgba(255,255,255,0.3);
        }
        
        /* ì¸ì‹ ì„±ê³µ ì‹œ íš¨ê³¼ */
        .success-border {
            border-color: #00cec9 !important;
            box-shadow: 0 0 20px #00cec9, 0 0 0 9999px rgba(0, 0, 0, 0.7) !important;
            transition: 0.2s;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .controls {
            background: #2d3436;
            padding: 20px;
            z-index: 10;
        }
        button {
            background: #ff7675;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
            cursor: pointer;
        }
        button:active { transform: scale(0.95); }

        /* ì¸ì‹ëœ ë¦¬ìŠ¤íŠ¸ (í† ìŠ¤íŠ¸ ë©”ì‹œì§€ì²˜ëŸ¼) */
        #log {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            z-index: 30;
            pointer-events: none;
        }
        .log-item {
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            margin-top: 5px;
            animation: fadeUp 0.3s ease-out;
        }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="score-board">
        <div class="total-score" id="score-display">0ì </div>
        <div class="last-card" id="status-msg">ì¹´ë“œë¥¼ ë°•ìŠ¤ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
    </div>

    <div class="camera-container">
        <div id="webcam-container"></div>
        <div class="guide-box" id="guide-box"></div>
        <div id="log"></div>
    </div>

    <div class="controls">
        <button onclick="init()" id="start-btn">ğŸ“· ì‹œì‘í•˜ê¸°</button>
        <button onclick="resetScore()" style="background:#636e72; margin-left:10px;">ğŸ”„ ë¦¬ì…‹</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/DZ34Dd5Ya/";
        let model, webcam, maxPredictions;
        let isRunning = false;
        let lastLabel = "";
        let detectionCount = 0; // ì—°ì† ì¸ì‹ íšŸìˆ˜ ì²´í¬ (ì˜¤ì‘ë™ ë°©ì§€)
        let totalScore = 0;
        let isCooldown = false; // ì¸ì‹ í›„ ì¿¨íƒ€ì„

        // ì˜¤ë””ì˜¤ íš¨ê³¼ (ëµë™)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSuccessSound() {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.frequency.value = 523.25; // ë„
            osc.type = 'sine';
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        async function init() {
            if(isRunning) return;
            const btn = document.getElementById('start-btn');
            btn.innerText = "ë¡œë”© ì¤‘...";
            
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = true; 
                webcam = new tmImage.Webcam(400, 400, flip); // ì •ì‚¬ê°í˜•ìœ¼ë¡œ ì˜ìƒ ë°›ìŒ
                await webcam.setup({ facingMode: "environment" }); 
                await webcam.play();
                
                // ê¸°ì¡´ ìº”ë²„ìŠ¤ ì§€ìš°ê³  ìƒˆë¡œ ë¶™ì´ê¸° (ëª¨ë°”ì¼ í˜¸í™˜ì„±)
                const container = document.getElementById("webcam-container");
                container.innerHTML = ""; 
                container.appendChild(webcam.canvas); // ì›¹ìº  í™”ë©´ì„ í™”ë©´ì— ë¶™ì„
                
                isRunning = true;
                btn.style.display = "none"; // ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€
                document.getElementById('status-msg').innerText = "ì¤€ë¹„ ì™„ë£Œ! ì¹´ë“œë¥¼ í•œ ì¥ì”© ë¹„ì¶°ì£¼ì„¸ìš”.";
                window.requestAnimationFrame(loop);
            } catch(e) {
                alert("ì¹´ë©”ë¼ë¥¼ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e);
                btn.innerText = "ì‹¤íŒ¨";
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            if (isCooldown) return; // ì¿¨íƒ€ì„ì´ë©´ ì¸ì‹ ì•ˆí•¨

            // ì›¹ìº  ì „ì²´ ì´ë¯¸ì§€ë¥¼ ëª¨ë¸ì— ë„£ê³  ì˜ˆì¸¡
            const prediction = await model.predict(webcam.canvas);
            
            // ê°€ì¥ í™•ë¥  ë†’ì€ ê²ƒ ì°¾ê¸°
            let highest = prediction[0];
            for (let i = 1; i < maxPredictions; i++) {
                if (prediction[i].probability > highest.probability) {
                    highest = prediction[i];
                }
            }

            // ì¡°ê±´: í™•ë¥ ì´ 90% ì´ìƒì´ì–´ì•¼ í•¨
            if (highest.probability > 0.90) {
                // ê°™ì€ ì¹´ë“œê°€ ê³„ì† ì¸ì‹ë˜ë©´ ì¹´ìš´íŠ¸ ì¦ê°€
                if (highest.className === lastLabel) {
                    detectionCount++;
                } else {
                    lastLabel = highest.className;
                    detectionCount = 0;
                }

                // 20í”„ë ˆì„(ì•½ 0.5ì´ˆ) ì´ìƒ ì—°ì†ìœ¼ë¡œ ê°™ì€ ì¹´ë“œë¡œ ì¸ì‹ë˜ë©´ "í™•ì •"
                if (detectionCount > 15) {
                    confirmCard(highest.className);
                }
            } else {
                detectionCount = 0; // ì¹´ë“œê°€ ì—†ê±°ë‚˜ ë¶ˆí™•ì‹¤í•˜ë©´ ì´ˆê¸°í™”
            }
        }

        function confirmCard(label) {
            // ìˆ«ì ì¶”ì¶œ
            const score = extractNumber(label);
            
            // ì ìˆ˜ í•©ì‚°
            totalScore += score;
            updateUI(label, score);
            playSuccessSound();

            // ì¿¨íƒ€ì„ ì ìš© (2ì´ˆê°„ ì¬ì¸ì‹ ë°©ì§€ - ì¹´ë“œ ë°”ê¿€ ì‹œê°„ ì¤Œ)
            isCooldown = true;
            detectionCount = 0;
            
            const guideBox = document.getElementById('guide-box');
            guideBox.classList.add('success-border'); // ë°•ìŠ¤ ìƒ‰ ë³€ê²½
            document.getElementById('status-msg').innerText = "ë‹¤ìŒ ì¹´ë“œë¥¼ ì¤€ë¹„í•˜ì„¸ìš”...";

            setTimeout(() => {
                isCooldown = false;
                guideBox.classList.remove('success-border');
                document.getElementById('status-msg').innerText = "ì¸ì‹ ì¤‘...";
            }, 1500);
        }

        function updateUI(label, score) {
            document.getElementById('score-display').innerText = totalScore + "ì ";
            
            // ë¡œê·¸ ì¶”ê°€
            const logDiv = document.getElementById('log');
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `ğŸ´ <b>${label}</b> ì¸ì‹! (+${score}ì )`;
            logDiv.prepend(item); // ìµœì‹  ê²ƒì´ ìœ„ë¡œ

            // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì‚­ì œ
            if (logDiv.children.length > 3) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function resetScore() {
            totalScore = 0;
            document.getElementById('score-display').innerText = "0ì ";
            document.getElementById('log').innerHTML = "";
            document.getElementById('status-msg').innerText = "ì ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        function extractNumber(str) {
            const num = str.replace(/[^0-9]/g, ""); 
            return num ? parseInt(num) : 0; 
        }
    </script>
</body>
</html>